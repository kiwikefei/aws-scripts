(()=>{"use strict";var e={570:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Certificate=void 0;const o=n(r(0)),c=n(r(677));class a extends o.Stack{constructor(e,t,r,i,s){super(e,t,r),this.certificate=new c.Certificate(this,i.getResourceID("Certificate"),{domainName:`*.${s.zoneName}`,subjectAlternativeNames:[],validation:{props:{hostedZone:s},method:c.ValidationMethod.DNS}})}}t.Certificate=a},892:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Stage=t.StackConfig=void 0;class r{constructor(e,t,r){this.getId=()=>this.id,this.getSlug=()=>this.getProperty("slug"),this.getAccountId=()=>this.getProperty("account_id"),this.getRegion=()=>this.getProperty("region"),this.getStackName=()=>this.stack.name,this.getStageName=()=>this.stage.getStageName(),this.getProperty=(e,t=void 0)=>{const r=this.stack?.[e]||this.stage.getProperty(e)||t;if(r)return r;throw new Error(`Missing value ${e} for stack`)},this.getEnvironment=()=>({account:this.getAccountId(),region:this.getRegion()}),this.getStackProps=()=>({env:this.getEnvironment()}),this.getFullResourceId=e=>`${this.getBaseResourceId()}-${e}`,this.getStackExportId=e=>`${this.getSlug()}-${this.getStageName()}-${e}`,this.getBaseResourceId=()=>`${this.getSlug()}-${this.getStageName()}-${this.getStackName()}`,this.getSecretArn=(e,t)=>`${this.getSecretBaseArn()}/${e}:${t}::`,this.getSecretBaseArn=()=>`${this.getBaseArn("secretsmanager")}:secret:${this.getSlug()}`,this.getSecretName=e=>`${this.getSlug()}/${e}`,this.getBaseArn=e=>`arn:aws:${e}:${this.getRegion()}:${this.getAccountId()}`,this.getResourceID=e=>e.replace(/[^A-Za-z0-9-]/gi,"-"),this.id=e,this.stage=t,this.stack=r}}t.StackConfig=r,t.Stage=class{constructor(e,t){this.getId=()=>this.id,this.getSlug=()=>this.getProperty("slug"),this.getStageName=()=>this.stage.name,this.getProperty=e=>this.stage?.[e],this.getStack=e=>{const t=this.stage.stacks?.[e];if(!t)throw new Error(`Invalid stack ${e}`);return new r(e,this,t)},this.id=e,this.stage=t}}},528:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.EcrRepositoryStack=void 0;const o=n(r(0)),c=n(r(830));class a extends o.Stack{constructor(e,t,r,i,s){super(e,t,r);const n=`${i.getSlug().toLowerCase()}/${s.toLowerCase()}`,a=new c.Repository(this,i.getResourceID(`${s}ECRRepository`),{repositoryName:n});a.addLifecycleRule({description:"Expire images older than 14 days",maxImageAge:o.Duration.days(14),rulePriority:1,tagStatus:c.TagStatus.UNTAGGED}),a.addLifecycleRule({description:"Expire dev images older than 14 days",maxImageAge:o.Duration.days(14),rulePriority:2,tagStatus:c.TagStatus.TAGGED,tagPrefixList:["dev-"]});const u=i.getStackExportId(`${s}ECRRepository`);new o.CfnOutput(this,`${u}Export`,{description:"ECR Repository name for Admin",exportName:u,value:a.repositoryArn})}}t.EcrRepositoryStack=a},278:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.FargateService=void 0;const o=n(r(0)),c=n(r(223)),a=n(r(434)),u=n(r(158)),l=n(r(187)),d=n(r(971)),p=n(r(244));class f extends o.Stack{constructor(e,t,r,i,s,n,o,f,g,h,b){super(e,t,r);const y=b?.subDomainWithoutDot??"",v=b?.healthCheckPath??"/health-check",m={},_=h.secrets;if(_)for(const e in Object.keys(_)){const t=_[e],[r,i]=t.split(":").slice(0,2),s=u.Secret.fromSecretNameV2(this,e,r);m[e]=c.Secret.fromSecretsManager(s,i)}this.service=new a.ApplicationLoadBalancedFargateService(this,i.getResourceID("AdminService"),{cluster:s,certificate:n,redirectHTTP:!0,memoryLimitMiB:h?.memoryLimitMiB||512,cpu:h?.cpu||256,desiredCount:h?.desiredCount||1,taskImageOptions:{image:c.ContainerImage.fromEcrRepository(f,g),environment:h?.environment||{},secrets:m}});const S=this.service.taskDefinition;S.addToExecutionRolePolicy(new l.PolicyStatement({actions:["ecr:GetAuthorizationToken","ecr:BatchCheckLayerAvailability","ecr:GetDownloadUrlForLayer","ecr:BatchGetImage"],resources:[f.repositoryArn]})),S.addToExecutionRolePolicy(new l.PolicyStatement({actions:["secretsmanager:GetSecretValue"],resources:[`${i.getSecretBaseArn()}/*`]})),this.service.targetGroup.configureHealthCheck({path:v}),new d.ARecord(this,i.getResourceID("Recordset"),{recordName:`${y}${o.zoneName}`,zone:o,target:{aliasTarget:new p.LoadBalancerTarget(this.service.loadBalancer)}})}}t.FargateService=f},493:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GithubDeployStack=void 0;const o=n(r(0)),c=n(r(187));class a extends o.Stack{constructor(e,t,r){super(e,t,r);const i=new c.User(this,"GithubDeployUser",{path:"/"}),s=new c.PolicyDocument({statements:[new c.PolicyStatement({effect:c.Effect.ALLOW,actions:["*"],resources:["*"]})]});i.attachInlinePolicy(new c.Policy(this,"GithubActionsAdministrator",{policyName:"GithubActionsAdministrator",document:s}));const n=new c.CfnAccessKey(this,"GithubActionsUserAccessKey",{userName:i.userName});new o.CfnOutput(this,"StackName",{description:"Stack name.",value:this.stackName}),new o.CfnOutput(this,"GithubUserAccessKeyID",{description:"Value of AWS_ACCESS_KEY_ID for github secrets",value:n.ref}),new o.CfnOutput(this,"GithubUserSecretAccessKey",{description:"Value of AWS_SECRET_ACCESS_KEY for github secrets",value:n.attrSecretAccessKey})}}t.GithubDeployStack=a},949:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.loadJsonFile=void 0;const o=n(r(423)),c=n(r(231));t.loadJsonFile=(e,t)=>{const r=o.resolve(e,t);if(!c.existsSync(r))throw new Error(`File does not exist: ${r}`);const i=c.readFileSync(r,"utf-8");return JSON.parse(i)}},719:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PostgresInstanceWithBastion=t.PostgresInstance=void 0;const o=n(r(0)),c=n(r(38)),a=n(r(158)),u=n(r(918)),l=n(r(971));class d extends o.Stack{constructor(e,t,r,i,s,n){super(e,t,r);const o=n?.version||u.PostgresEngineVersion.VER_15_2,l=new a.Secret(this,i.getResourceID("RdsCredentials"),{secretName:i.getSecretName("RdsCredentials"),generateSecretString:{secretStringTemplate:JSON.stringify({username:"master"}),excludePunctuation:!0,passwordLength:30,includeSpace:!1,generateStringKey:"password"}}),d=new c.SecurityGroup(this,i.getResourceID("DatabaseSecurityGroup"),{vpc:s});d.addIngressRule(c.Peer.ipv4(s.vpcCidrBlock),c.Port.tcp(5432));const p=`${i.getFullResourceId("RdsInstance")}`;this.rdsInstance=new u.DatabaseInstance(this,p,{engine:u.DatabaseInstanceEngine.postgres({version:o}),instanceType:c.InstanceType.of(c.InstanceClass.T3,c.InstanceSize.MICRO),vpc:s,databaseName:"website",instanceIdentifier:p,maxAllocatedStorage:200,securityGroups:[d],credentials:u.Credentials.fromSecret(l)})}}t.PostgresInstance=d,t.PostgresInstanceWithBastion=class extends d{constructor(e,t,r,i,s,n,o){super(e,t,r,i,s);const a=new c.SecurityGroup(this,i.getResourceID("BastionSecurityGroup"),{vpc:s});a.addIngressRule(c.Peer.anyIpv4(),c.Port.tcp(22));const u=new c.CfnKeyPair(this,i.getResourceID("BastionKeyPair"),{keyName:i.getFullResourceId("BastionKeyPair"),keyType:"ed25519"}),d=new c.Instance(this,i.getResourceID("BastionHost"),{vpc:s,securityGroup:a,instanceType:c.InstanceType.of(c.InstanceClass.T2,c.InstanceSize.NANO),machineImage:c.MachineImage.latestAmazonLinux2(),vpcSubnets:{subnetType:c.SubnetType.PUBLIC},keyName:u.keyName});d.connections.allowFromAnyIpv4(c.Port.tcp(22),"SSH access from the internet"),this.rdsInstance.connections.allowFrom(d,c.Port.tcp(5432));const p=new c.CfnEIP(this,i.getResourceID("BastionEIP"));new c.CfnEIPAssociation(this,i.getResourceID("BastionEipAssociation"),{eip:p.ref,instanceId:d.instanceId});const f=o?.bastionSubdomain??"ssh.";new l.ARecord(this,i.getResourceID("BastionRecordSet"),{recordName:`${f}${n.zoneName}`,zone:n,target:l.RecordTarget.fromIpAddresses(p.attrPublicIp)})}}},970:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.S3Bucket=void 0;const o=n(r(0)),c=n(r(530)),a=n(r(187));class u extends o.Stack{constructor(e,t,r,i,s){super(e,t,r);const n=s?.bucketName,u=s?.publicPath||"/*",l=s?.bucketAccess||"Private";this.bucket=new c.Bucket(this,i.getResourceID("Bucket"),{removalPolicy:o.RemovalPolicy.DESTROY,publicReadAccess:!1,bucketName:n,blockPublicAccess:{blockPublicAcls:!1,blockPublicPolicy:!1,ignorePublicAcls:!1,restrictPublicBuckets:!1}}),"Public"==l&&this.bucket.addToResourcePolicy(new a.PolicyStatement({actions:["s3:GetObject"],principals:[new a.AnyPrincipal],resources:[this.bucket.arnForObjects(u)]}))}}t.S3Bucket=u},138:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(r(570),t),s(r(892),t),s(r(528),t),s(r(278),t),s(r(493),t),s(r(949),t),s(r(719),t),s(r(970),t)},0:e=>{e.exports=require("aws-cdk-lib")},677:e=>{e.exports=require("aws-cdk-lib/aws-certificatemanager")},38:e=>{e.exports=require("aws-cdk-lib/aws-ec2")},830:e=>{e.exports=require("aws-cdk-lib/aws-ecr")},223:e=>{e.exports=require("aws-cdk-lib/aws-ecs")},434:e=>{e.exports=require("aws-cdk-lib/aws-ecs-patterns")},187:e=>{e.exports=require("aws-cdk-lib/aws-iam")},918:e=>{e.exports=require("aws-cdk-lib/aws-rds")},971:e=>{e.exports=require("aws-cdk-lib/aws-route53")},244:e=>{e.exports=require("aws-cdk-lib/aws-route53-targets")},530:e=>{e.exports=require("aws-cdk-lib/aws-s3")},158:e=>{e.exports=require("aws-cdk-lib/aws-secretsmanager")},231:e=>{e.exports=require("fs")},423:e=>{e.exports=require("path")}},t={},r=function r(i){var s=t[i];if(void 0!==s)return s.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}(138),i=exports;for(var s in r)i[s]=r[s];r.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();